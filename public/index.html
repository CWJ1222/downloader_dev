<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fastcamp Downloader</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #4ecca3;
        }

        .card {
            background: #16213e;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: #888;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #0f0f23;
            color: #fff;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #4ecca3;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4ecca3;
            color: #1a1a2e;
        }

        .btn-primary:hover {
            background: #3db892;
        }

        .btn-secondary {
            background: #374151;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #ef4444;
            color: #fff;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            flex: none;
            padding: 6px 12px;
            font-size: 12px;
        }

        /* ìƒíƒœ í‘œì‹œ */
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            background: #0f0f23;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .status-dot.connected {
            background: #4ecca3;
        }

        /* ì§„í–‰ë¥  ë°” */
        .progress-container {
            margin-top: 20px;
        }

        .progress-bar {
            height: 8px;
            background: #0f0f23;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecca3, #45b7d1);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            margin-top: 8px;
            color: #888;
            font-size: 14px;
        }

        /* ëª©ë¡ */
        .list-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .select-all {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .part-group {
            margin-bottom: 12px;
        }

        .part-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #1f2937;
            border-radius: 6px;
            cursor: pointer;
        }

        .part-header:hover {
            background: #2d3748;
        }

        .part-title {
            flex: 1;
            font-weight: 500;
        }

        .part-count {
            color: #888;
            font-size: 13px;
        }

        .clip-list {
            padding-left: 24px;
            margin-top: 4px;
        }

        .clip-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 4px;
        }

        .clip-item:hover {
            background: #1f2937;
        }

        .clip-title {
            flex: 1;
            font-size: 14px;
        }

        .clip-status {
            font-size: 16px;
        }

        .clip-progress {
            width: 100px;
            font-size: 12px;
            color: #888;
        }

        /* ë¡œê·¸ */
        .log-container {
            background: #0f0f23;
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #1f2937;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #666;
            margin-right: 8px;
        }

        .log-info { color: #4ecca3; }
        .log-error { color: #ef4444; }
        .log-warn { color: #f59e0b; }

        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f0f23;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        /* ëª¨ë‹¬ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #16213e;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #333;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-top: 1px solid #333;
            gap: 12px;
        }

        .modal-footer .current-path {
            flex: 1;
            font-size: 12px;
            color: #888;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* í´ë” ë¸Œë¼ìš°ì € */
        .folder-roots {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #333;
        }

        .folder-root-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #0f0f23;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .folder-root-btn:hover {
            background: #1f2937;
            border-color: #4ecca3;
        }

        .folder-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .folder-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #0f0f23;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .folder-item:hover {
            background: #1f2937;
        }

        .folder-item.selected {
            background: #1f2937;
            border: 1px solid #4ecca3;
        }

        .folder-icon {
            font-size: 18px;
        }

        .folder-name {
            flex: 1;
            font-size: 14px;
        }

        .folder-parent {
            color: #4ecca3;
        }

        .folder-empty {
            text-align: center;
            color: #666;
            padding: 40px;
        }

        /* ì €ì¥ í´ë” ì…ë ¥ ê·¸ë£¹ */
        .input-with-btn {
            display: flex;
            gap: 8px;
        }

        .input-with-btn input {
            flex: 1;
        }

        .btn-browse {
            padding: 12px 16px;
            background: #374151;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-browse:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fastcamp Downloader</h1>

        <!-- ì„¤ì • ì¹´ë“œ -->
        <div class="card">
            <div class="form-group">
                <label>ê°•ì˜ URL</label>
                <input type="text" id="courseUrl" placeholder="https://kdt.fastcampus.co.kr/classroom/...">
            </div>
            <div class="form-group">
                <label>ì´ë©”ì¼</label>
                <input type="email" id="email" placeholder="fastcampus@example.com">
            </div>
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div class="form-group">
                <label>ì €ì¥ í´ë”</label>
                <div class="input-with-btn">
                    <input type="text" id="outputDir" placeholder="./videos">
                    <button type="button" class="btn-browse" id="btnBrowse">ì°¾ì•„ë³´ê¸°</button>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn-secondary" id="btnFetchList">ëª©ë¡ ê°€ì ¸ì˜¤ê¸°</button>
                <button class="btn-primary" id="btnDownload" disabled>ì„ íƒ í•­ëª© ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>

        <!-- ìƒíƒœ ì¹´ë“œ -->
        <div class="card">
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-dot" id="wsStatus"></span>
                    <span id="wsStatusText">ì—°ê²° ì¤‘...</span>
                </div>
                <div class="status-item">
                    <span>ì™„ë£Œ: <strong id="completedCount">0</strong></span>
                </div>
                <div class="status-item">
                    <span>ì§„í–‰: <strong id="inProgressCount">0</strong></span>
                </div>
                <div class="status-item">
                    <span>ëŒ€ê¸°: <strong id="pendingCount">0</strong></span>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">ëŒ€ê¸° ì¤‘</div>
            </div>
        </div>

        <!-- ëª©ë¡ ì¹´ë“œ -->
        <div class="card">
            <div class="list-header">
                <label class="select-all">
                    <input type="checkbox" id="selectAll">
                    <span>ì „ì²´ ì„ íƒ</span>
                </label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span id="listCount">0ê°œ í•­ëª©</span>
                    <button class="btn-small btn-danger" id="btnClearList" style="display: none;">ëª©ë¡ ì‚­ì œ</button>
                </div>
            </div>
            <div class="list-container" id="listContainer">
                <p style="color: #666; text-align: center; padding: 40px;">
                    ëª©ë¡ ê°€ì ¸ì˜¤ê¸°ë¥¼ í´ë¦­í•˜ì—¬ ê°•ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”
                </p>
            </div>
        </div>

        <!-- ë¡œê·¸ ì¹´ë“œ -->
        <div class="card">
            <h3 style="margin-bottom: 12px; font-size: 14px; color: #888;">ë¡œê·¸</h3>
            <div class="log-container" id="logContainer">
                <div class="log-entry">
                    <span class="log-time">--:--:--</span>
                    <span class="log-info">ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- í´ë” ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="folderModal">
        <div class="modal">
            <div class="modal-header">
                <h3>í´ë” ì„ íƒ</h3>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="folder-roots" id="folderRoots"></div>
                <div class="folder-list" id="folderList"></div>
            </div>
            <div class="modal-footer">
                <span class="current-path" id="currentPath"></span>
                <button class="btn-secondary" id="btnSelectFolder">ì´ í´ë” ì„ íƒ</button>
            </div>
        </div>
    </div>

    <script>
        // ìƒíƒœ
        let ws = null;
        let clipList = [];
        let isDownloading = false;
        let isFetching = false;
        let isLoggedIn = false;
        let currentDownloadFile = '';

        // DOM ìš”ì†Œ
        const elements = {
            courseUrl: document.getElementById('courseUrl'),
            email: document.getElementById('email'),
            password: document.getElementById('password'),
            outputDir: document.getElementById('outputDir'),
            btnFetchList: document.getElementById('btnFetchList'),
            btnDownload: document.getElementById('btnDownload'),
            btnBrowse: document.getElementById('btnBrowse'),
            wsStatus: document.getElementById('wsStatus'),
            wsStatusText: document.getElementById('wsStatusText'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            listContainer: document.getElementById('listContainer'),
            logContainer: document.getElementById('logContainer'),
            selectAll: document.getElementById('selectAll'),
            completedCount: document.getElementById('completedCount'),
            inProgressCount: document.getElementById('inProgressCount'),
            pendingCount: document.getElementById('pendingCount'),
            listCount: document.getElementById('listCount'),
            btnClearList: document.getElementById('btnClearList'),
            // í´ë” ë¸Œë¼ìš°ì € ëª¨ë‹¬
            folderModal: document.getElementById('folderModal'),
            modalClose: document.getElementById('modalClose'),
            folderRoots: document.getElementById('folderRoots'),
            folderList: document.getElementById('folderList'),
            currentPath: document.getElementById('currentPath'),
            btnSelectFolder: document.getElementById('btnSelectFolder')
        };

        // í´ë” ë¸Œë¼ìš°ì € ìƒíƒœ
        let currentBrowsePath = '';

        // ì´ˆê¸°í™”
        async function init() {
            // ê¸°ë³¸ ì„¤ì • ë¡œë“œ
            const config = await fetch('/api/config').then(r => r.json());
            elements.courseUrl.value = config.defaultCourseUrl;
            elements.outputDir.value = config.defaultOutputDir;

            // ì €ì¥ëœ ìƒíƒœ ë¡œë“œ
            try {
                const saved = await fetch('/api/saved-status').then(r => r.json());
                if (saved.success && saved.data.length > 0) {
                    renderList(saved.data);
                    addLog(`ì €ì¥ëœ ìƒíƒœ ë¡œë“œ: ${saved.data.length}ê°œ í•­ëª©`, 'info');
                }
            } catch (e) {}

            // WebSocket ì—°ê²°
            connectWebSocket();

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            elements.btnFetchList.addEventListener('click', fetchList);
            elements.btnDownload.addEventListener('click', startDownload);
            elements.selectAll.addEventListener('change', toggleSelectAll);
            elements.btnClearList.addEventListener('click', clearList);

            // í´ë” ë¸Œë¼ìš°ì € ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            elements.btnBrowse.addEventListener('click', openFolderBrowser);
            elements.modalClose.addEventListener('click', closeFolderBrowser);
            elements.btnSelectFolder.addEventListener('click', selectFolder);
            elements.folderModal.addEventListener('click', (e) => {
                if (e.target === elements.folderModal) closeFolderBrowser();
            });

            // ì´ˆê¸° ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìƒíƒœ
            updateDownloadButton();
        }

        // WebSocket ì—°ê²°
        function connectWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}`);

            ws.onopen = () => {
                elements.wsStatus.classList.add('connected');
                elements.wsStatusText.textContent = 'ì—°ê²°ë¨';
                addLog('WebSocket ì—°ê²°ë¨', 'info');
            };

            ws.onclose = () => {
                elements.wsStatus.classList.remove('connected');
                elements.wsStatusText.textContent = 'ì—°ê²° ëŠê¹€';
                setTimeout(connectWebSocket, 3000);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };
        }

        // ë©”ì‹œì§€ ì²˜ë¦¬
        function handleMessage(msg) {
            switch (msg.type) {
                case 'progress':
                    handleProgress(msg.data);
                    break;
                case 'clipStatus':
                    updateClipStatus(msg.clipIndex, msg.status);
                    break;
                case 'log':
                    addLog(msg.message, msg.level);
                    break;
                case 'downloadComplete':
                    handleDownloadComplete(msg.data);
                    break;
                case 'listUpdate':
                    // ì‹¤ì‹œê°„ ëª©ë¡ ì—…ë°ì´íŠ¸
                    renderList(msg.data);
                    break;
                case 'status':
                    // ì´ˆê¸° ìƒíƒœ
                    isLoggedIn = msg.data.isLoggedIn || false;
                    isFetching = msg.data.isFetching || false;
                    updateDownloadButton();
                    break;
            }
        }

        // ì§„í–‰ë¥  ì²˜ë¦¬
        function handleProgress(data) {
            if (data.type === 'pipeline') {
                // íŒŒì´í”„ë¼ì¸ ì§„í–‰ë¥  (URL ìˆ˜ì§‘ + ë³‘ë ¬ ë‹¤ìš´ë¡œë“œ)
                elements.progressFill.style.width = data.percent + '%';
                const statusParts = [];
                statusParts.push(`URL: ${data.urlCollected}/${data.total}`);
                if (data.downloading > 0) statusParts.push(`ë‹¤ìš´ë¡œë“œ ì¤‘: ${data.downloading}`);
                if (data.queued > 0) statusParts.push(`ëŒ€ê¸°: ${data.queued}`);
                statusParts.push(`ì™„ë£Œ: ${data.completed}`);
                if (data.skipped > 0) statusParts.push(`ìŠ¤í‚µ: ${data.skipped}`);
                if (data.failed > 0) statusParts.push(`ì‹¤íŒ¨: ${data.failed}`);
                statusParts.push(`(${data.percent}%)`);
                elements.progressText.textContent = statusParts.join(' | ');

                // ì‹¤ì‹œê°„ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                elements.completedCount.textContent = data.completed + data.skipped;
                elements.inProgressCount.textContent = data.downloading;
                elements.pendingCount.textContent = data.total - data.completed - data.skipped - data.failed - data.downloading;
            } else if (data.type === 'overall') {
                // ì „ì²´ ì§„í–‰ë¥  (ë ˆê±°ì‹œ í˜¸í™˜)
                elements.progressFill.style.width = data.percent + '%';
                elements.progressText.textContent = `ì „ì²´: ${data.completed + data.failed}/${data.total} (${data.percent}%) - ì„±ê³µ: ${data.completed}, ì‹¤íŒ¨: ${data.failed}`;
            } else if (data.type === 'download') {
                // ê°œë³„ íŒŒì¼ ì§„í–‰ë¥ 
                currentDownloadFile = data.file;
                const clipItem = document.querySelector(`.clip-item[data-id] .clip-status:contains('â³')`);
                // í˜„ì¬ ë‹¤ìš´ë¡œë“œ ì¤‘ì¸ íŒŒì¼ì˜ ì§„í–‰ë¥ ì€ ë¡œê·¸ì— í‘œì‹œ
            } else if (data.type === 'fetch') {
                // ëª©ë¡ ìˆ˜ì§‘ ì§„í–‰ë¥ 
                elements.progressFill.style.width = data.percent + '%';
                elements.progressText.textContent = `ëª©ë¡ ìˆ˜ì§‘ ì¤‘: ${data.current}/${data.total} Part (${data.percent}%)`;
                // ìˆ˜ì§‘ ì¤‘ì¼ ë•Œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                if (isFetching && data.percent > 0) {
                    elements.btnFetchList.textContent = 'â¹ ì¤‘ì§€';
                }
            }
        }

        // í´ë¦½ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateClipStatus(clipIndex, status) {
            const clip = clipList.find(c => c.index === clipIndex);
            if (clip) {
                clip.status = status;
                const clipItem = document.querySelector(`.clip-item[data-id="${clipIndex}"]`);
                if (clipItem) {
                    const statusEl = clipItem.querySelector('.clip-status');
                    if (statusEl) {
                        statusEl.textContent = getStatusIcon(status);
                    }
                }
                updateCounts();
            }
        }

        // ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ì²˜ë¦¬
        function handleDownloadComplete(data) {
            isDownloading = false;
            updateDownloadButton();
            const skipMsg = data.skipped ? `, ìŠ¤í‚µ ${data.skipped}` : '';
            addLog(`ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ì„±ê³µ ${data.completed}${skipMsg}, ì‹¤íŒ¨ ${data.failed}`, data.failed > 0 ? 'warn' : 'info');
        }

        // ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function fetchList() {
            // ì´ë¯¸ ìˆ˜ì§‘ ì¤‘ì´ë©´ ì¤‘ì§€
            if (isFetching) {
                await stopFetch();
                return;
            }

            const email = elements.email.value;
            const password = elements.password.value;
            const courseUrl = elements.courseUrl.value;

            if (!email || !password) {
                addLog('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            isFetching = true;
            elements.btnFetchList.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
            elements.btnFetchList.classList.remove('btn-secondary');
            elements.btnFetchList.classList.add('btn-danger');
            elements.progressFill.style.width = '0%';
            elements.progressText.textContent = 'ë¡œê·¸ì¸ ì¤‘...';

            try {
                const response = await fetch('/api/fetch-list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ courseUrl, email, password })
                });
                const result = await response.json();

                if (result.success) {
                    isLoggedIn = true;
                    addLog(result.message, 'info');
                    if (result.data && result.data.length > 0) {
                        renderList(result.data);
                    }
                    elements.progressText.textContent = result.stopped ? 'ëª©ë¡ ìˆ˜ì§‘ ì¤‘ì§€ë¨' : 'ëª©ë¡ ìˆ˜ì§‘ ì™„ë£Œ';
                } else {
                    addLog(result.message || 'ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨', 'error');
                    elements.progressText.textContent = 'ì‹¤íŒ¨';
                }
            } catch (error) {
                addLog('ì˜¤ë¥˜: ' + error.message, 'error');
                elements.progressText.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
            } finally {
                isFetching = false;
                elements.btnFetchList.textContent = 'ëª©ë¡ ê°€ì ¸ì˜¤ê¸°';
                elements.btnFetchList.classList.remove('btn-danger');
                elements.btnFetchList.classList.add('btn-secondary');
                updateDownloadButton();
            }
        }

        // ëª©ë¡ ìˆ˜ì§‘ ì¤‘ì§€
        async function stopFetch() {
            try {
                elements.btnFetchList.textContent = 'ì¤‘ì§€ ì¤‘...';
                await fetch('/api/stop-fetch', { method: 'POST' });
                addLog('ëª©ë¡ ìˆ˜ì§‘ ì¤‘ì§€ ìš”ì²­ë¨', 'warn');
            } catch (error) {
                addLog('ì¤‘ì§€ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ë‹¤ìš´ë¡œë“œ ì¤‘ì§€
        async function stopDownload() {
            try {
                elements.btnDownload.textContent = 'ì¤‘ì§€ ì¤‘...';
                elements.btnDownload.disabled = true;
                await fetch('/api/stop', { method: 'POST' });
                addLog('ë‹¤ìš´ë¡œë“œ ì¤‘ì§€ ìš”ì²­ë¨', 'warn');
            } catch (error) {
                addLog('ì¤‘ì§€ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ëª©ë¡ ì‚­ì œ
        async function clearList() {
            if (!confirm('ì €ì¥ëœ ëª©ë¡ê³¼ ì§„í–‰ ìƒíƒœë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                await fetch('/api/clear-status', { method: 'POST' });
                clipList = [];
                elements.listContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">ëª©ë¡ ê°€ì ¸ì˜¤ê¸°ë¥¼ í´ë¦­í•˜ì—¬ ê°•ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”</p>';
                elements.listCount.textContent = '0ê°œ í•­ëª©';
                elements.btnClearList.style.display = 'none';
                updateCounts();
                addLog('ëª©ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
            } catch (error) {
                addLog('ëª©ë¡ ì‚­ì œ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateDownloadButton() {
            const hasItems = clipList.length > 0;
            const hasSelected = clipList.some(c => c.selected && c.status !== 'completed');

            if (isDownloading) {
                // ë‹¤ìš´ë¡œë“œ ì¤‘ì¼ ë•ŒëŠ” ì¤‘ì§€ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
                elements.btnDownload.disabled = false;
                elements.btnDownload.textContent = 'â¹ ë‹¤ìš´ë¡œë“œ ì¤‘ì§€';
                elements.btnDownload.classList.remove('btn-primary');
                elements.btnDownload.classList.add('btn-danger');
                elements.btnDownload.title = 'í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ ì¤‘ì§€';
            } else {
                // ë‹¤ìš´ë¡œë“œ ì¤‘ì´ ì•„ë‹ ë•Œ
                elements.btnDownload.disabled = !isLoggedIn || !hasItems || !hasSelected;
                elements.btnDownload.textContent = 'ì„ íƒ í•­ëª© ë‹¤ìš´ë¡œë“œ';
                elements.btnDownload.classList.remove('btn-danger');
                elements.btnDownload.classList.add('btn-primary');

                if (!isLoggedIn) {
                    elements.btnDownload.title = 'ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”';
                } else if (!hasSelected) {
                    elements.btnDownload.title = 'ë‹¤ìš´ë¡œë“œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”';
                } else {
                    elements.btnDownload.title = '';
                }
            }
        }

        // ë‹¤ìš´ë¡œë“œ ì‹œì‘/ì¤‘ì§€ í† ê¸€
        async function startDownload() {
            // ì´ë¯¸ ë‹¤ìš´ë¡œë“œ ì¤‘ì´ë©´ ì¤‘ì§€
            if (isDownloading) {
                await stopDownload();
                return;
            }

            const selectedItems = clipList.filter(item => item.selected && item.status !== 'completed');
            if (selectedItems.length === 0) {
                addLog('ë‹¤ìš´ë¡œë“œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš” (ì™„ë£Œëœ í•­ëª© ì œì™¸)', 'warn');
                return;
            }

            isDownloading = true;
            updateDownloadButton();
            elements.progressFill.style.width = '0%';
            elements.progressText.textContent = 'ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì¤‘...';

            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        items: selectedItems,
                        outputDir: elements.outputDir.value
                    })
                });
                const result = await response.json();
                if (!result.success) {
                    addLog(result.message, 'error');
                    isDownloading = false;
                    updateDownloadButton();
                }
            } catch (error) {
                addLog('ì˜¤ë¥˜: ' + error.message, 'error');
                isDownloading = false;
                updateDownloadButton();
            }
        }

        // ëª©ë¡ ë Œë”ë§
        function renderList(items) {
            clipList = items.map(item => ({
                ...item,
                selected: item.selected !== undefined ? item.selected : (item.status !== 'completed')
            }));

            elements.listCount.textContent = `${items.length}ê°œ í•­ëª©`;

            // ëª©ë¡ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            elements.btnClearList.style.display = items.length > 0 ? 'inline-block' : 'none';

            if (items.length === 0) {
                elements.listContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            // Partë³„ë¡œ ê·¸ë£¹í™”
            const grouped = {};
            clipList.forEach(item => {
                if (!grouped[item.partTitle]) {
                    grouped[item.partTitle] = [];
                }
                grouped[item.partTitle].push(item);
            });

            let html = '';
            Object.entries(grouped).forEach(([partTitle, clips]) => {
                const completedCount = clips.filter(c => c.status === 'completed').length;
                const allSelected = clips.every(c => c.selected);
                html += `
                    <div class="part-group">
                        <div class="part-header">
                            <input type="checkbox" class="part-checkbox" data-part="${partTitle}" ${allSelected ? 'checked' : ''}>
                            <span class="part-title">${partTitle}</span>
                            <span class="part-count">${completedCount}/${clips.length} ì™„ë£Œ</span>
                        </div>
                        <div class="clip-list">
                            ${clips.map(clip => `
                                <div class="clip-item" data-id="${clip.index}">
                                    <input type="checkbox" class="clip-checkbox" ${clip.selected ? 'checked' : ''}>
                                    <span class="clip-status">${getStatusIcon(clip.status)}</span>
                                    <span class="clip-title">${clip.title}</span>
                                    <span class="clip-progress"></span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            elements.listContainer.innerHTML = html;

            // Part ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
            document.querySelectorAll('.part-checkbox').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const partTitle = e.target.dataset.part;
                    const checked = e.target.checked;
                    clipList.filter(c => c.partTitle === partTitle).forEach(c => c.selected = checked);
                    e.target.closest('.part-group').querySelectorAll('.clip-checkbox').forEach(ccb => ccb.checked = checked);
                    updateCounts();
                });
            });

            // í´ë¦½ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
            document.querySelectorAll('.clip-checkbox').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const id = parseInt(e.target.closest('.clip-item').dataset.id);
                    const clip = clipList.find(c => c.index === id);
                    if (clip) clip.selected = e.target.checked;
                    updateCounts();
                    updatePartCheckbox(clip.partTitle);
                });
            });

            updateCounts();
        }

        // Part ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updatePartCheckbox(partTitle) {
            const partClips = clipList.filter(c => c.partTitle === partTitle);
            const allSelected = partClips.every(c => c.selected);
            const partCb = document.querySelector(`.part-checkbox[data-part="${partTitle}"]`);
            if (partCb) partCb.checked = allSelected;
        }

        // ìƒíƒœ ì•„ì´ì½˜
        function getStatusIcon(status) {
            switch (status) {
                case 'completed': return 'âœ…';
                case 'downloading': return 'â³';
                case 'failed': return 'âŒ';
                default: return 'â¬œ';
            }
        }

        // ì „ì²´ ì„ íƒ
        function toggleSelectAll() {
            const checked = elements.selectAll.checked;
            clipList.forEach(item => item.selected = checked);
            document.querySelectorAll('.clip-checkbox, .part-checkbox').forEach(cb => cb.checked = checked);
            updateCounts();
        }

        // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateCounts() {
            const completed = clipList.filter(c => c.status === 'completed').length;
            const inProgress = clipList.filter(c => c.status === 'downloading').length;
            const pending = clipList.filter(c => !c.status || c.status === 'pending').length;
            const failed = clipList.filter(c => c.status === 'failed').length;

            elements.completedCount.textContent = completed;
            elements.inProgressCount.textContent = inProgress;
            elements.pendingCount.textContent = pending + failed;

            // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ
            elements.selectAll.checked = clipList.length > 0 && clipList.every(c => c.selected);

            // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateDownloadButton();
        }

        // ë¡œê·¸ ì¶”ê°€
        function addLog(message, level = 'info') {
            const time = new Date().toLocaleTimeString('ko-KR', { hour12: false });
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">${time}</span><span class="log-${level}">${message}</span>`;
            elements.logContainer.appendChild(entry);
            elements.logContainer.scrollTop = elements.logContainer.scrollHeight;

            // ìµœëŒ€ 100ê°œ ë¡œê·¸ ìœ ì§€
            while (elements.logContainer.children.length > 100) {
                elements.logContainer.removeChild(elements.logContainer.firstChild);
            }
        }

        // ==================== í´ë” ë¸Œë¼ìš°ì € ====================

        // í´ë” ë¸Œë¼ìš°ì € ì—´ê¸°
        async function openFolderBrowser() {
            elements.folderModal.classList.add('active');

            // ë£¨íŠ¸ ëª©ë¡ ë¡œë“œ
            await loadFolderRoots();

            // í˜„ì¬ ì…ë ¥ëœ ê²½ë¡œ ë˜ëŠ” í™ˆ ë””ë ‰í† ë¦¬ë¡œ ì‹œì‘
            const startPath = elements.outputDir.value || '';
            if (startPath && startPath !== './videos') {
                await browsePath(startPath);
            } else {
                // ë£¨íŠ¸ ëª©ë¡ì˜ ì²« ë²ˆì§¸ í•­ëª©ìœ¼ë¡œ ì‹œì‘
                const roots = await fetch('/api/browse/roots').then(r => r.json());
                if (roots.success && roots.roots.length > 0) {
                    await browsePath(roots.roots[0].path);
                }
            }
        }

        // í´ë” ë¸Œë¼ìš°ì € ë‹«ê¸°
        function closeFolderBrowser() {
            elements.folderModal.classList.remove('active');
        }

        // ë£¨íŠ¸ í´ë” ëª©ë¡ ë¡œë“œ
        async function loadFolderRoots() {
            try {
                const response = await fetch('/api/browse/roots');
                const data = await response.json();

                if (data.success) {
                    elements.folderRoots.innerHTML = data.roots.map(root => `
                        <button class="folder-root-btn" data-path="${root.path}">
                            <span>${root.icon}</span>
                            <span>${root.name}</span>
                        </button>
                    `).join('');

                    // ë£¨íŠ¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    elements.folderRoots.querySelectorAll('.folder-root-btn').forEach(btn => {
                        btn.addEventListener('click', () => browsePath(btn.dataset.path));
                    });
                }
            } catch (error) {
                console.error('ë£¨íŠ¸ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ê²½ë¡œ íƒìƒ‰
        async function browsePath(targetPath) {
            try {
                const response = await fetch(`/api/browse?path=${encodeURIComponent(targetPath)}`);
                const data = await response.json();

                if (!data.success) {
                    addLog(`í´ë” íƒìƒ‰ ì˜¤ë¥˜: ${data.error}`, 'error');
                    return;
                }

                currentBrowsePath = data.currentPath;
                elements.currentPath.textContent = data.currentPath;

                let html = '';

                // ìƒìœ„ í´ë” ë²„íŠ¼
                if (data.parentPath) {
                    html += `
                        <div class="folder-item folder-parent" data-path="${data.parentPath}">
                            <span class="folder-icon">â¬†ï¸</span>
                            <span class="folder-name">ìƒìœ„ í´ë”ë¡œ</span>
                        </div>
                    `;
                }

                // í´ë” ëª©ë¡
                if (data.folders.length > 0) {
                    html += data.folders.map(folder => `
                        <div class="folder-item" data-path="${folder.path}">
                            <span class="folder-icon">ğŸ“</span>
                            <span class="folder-name">${folder.name}</span>
                        </div>
                    `).join('');
                } else if (!data.parentPath) {
                    html = '<div class="folder-empty">í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                }

                elements.folderList.innerHTML = html;

                // í´ë” í´ë¦­ ì´ë²¤íŠ¸ (ë”ë¸”í´ë¦­ìœ¼ë¡œ ì´ë™)
                elements.folderList.querySelectorAll('.folder-item').forEach(item => {
                    item.addEventListener('dblclick', () => browsePath(item.dataset.path));
                    item.addEventListener('click', () => {
                        // ì‹±ê¸€ í´ë¦­ì€ ì„ íƒ (ìƒìœ„ í´ë” ì œì™¸)
                        if (!item.classList.contains('folder-parent')) {
                            elements.folderList.querySelectorAll('.folder-item').forEach(i => i.classList.remove('selected'));
                            item.classList.add('selected');
                            currentBrowsePath = item.dataset.path;
                            elements.currentPath.textContent = item.dataset.path;
                        } else {
                            // ìƒìœ„ í´ë”ëŠ” ë°”ë¡œ ì´ë™
                            browsePath(item.dataset.path);
                        }
                    });
                });
            } catch (error) {
                addLog(`í´ë” íƒìƒ‰ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // í´ë” ì„ íƒ í™•ì •
        function selectFolder() {
            if (currentBrowsePath) {
                elements.outputDir.value = currentBrowsePath;
                addLog(`ì €ì¥ ê²½ë¡œ ì„¤ì •: ${currentBrowsePath}`, 'info');
            }
            closeFolderBrowser();
        }

        // ==================== ì´ˆê¸°í™” ====================

        // ì‹œì‘
        init();
    </script>
</body>
</html>
